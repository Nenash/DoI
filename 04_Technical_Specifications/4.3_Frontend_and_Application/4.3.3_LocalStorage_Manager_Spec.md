# 4.3.3 LocalStorage Manager Specification

**Project:** Bones on Ice - Web Edition v1.0
**Audience:** Frontend UI Developer
**Purpose:** To define a safe and version-aware module for persisting player statistics in the browser's `localStorage`. This manager will act as the sole interface for reading from and writing to local storage, preventing data corruption and ensuring future updates are handled gracefully.

---

## 1. Core Principles

*   **Encapsulation:** No other module in the application should ever call `localStorage.getItem()` or `localStorage.setItem()` directly. All interactions must go through this manager.
*   **Data Integrity:** The manager must be resilient to malformed or corrupted data. It should never crash the application; instead, it should reset to a default state if it encounters invalid data.
*   **Versioning:** The data schema must be versioned to allow for seamless data migration when future application updates introduce new teams or stat-tracking requirements.

---

## 2. `LocalStorageManager` Module

### 2.1. Constants
```$
const STORAGE_KEY = 'bonesOnIce_playerStats';
const CURRENT_SCHEMA_VERSION = 1;
```$

### 2.2. API (Public Methods)
*   `init()`: The main entry point. Called once when the application starts. It reads, validates, and, if necessary, migrates or creates the user's stat file in memory.
*   `getStats()`: Returns the current, in-memory statistics object.
*   `updateStats(gameResult)`: Takes a `gameResult` object after a match and updates the in-memory stats.
*   `saveStats()`: Persists the current in-memory stats to `localStorage`.
*   `resetStats()`: Wipes the user's statistics and resets to the default schema.

---

## 3. Data Schema (Version 1)

The object that will be `JSON.stringify`-ed and stored in `localStorage`.

```$
{
  "version": 1,
  "lastModified": "2023-10-27T10:00:00Z",
  "stats": {
    "team_perun": { "wins": 0, "losses": 0 },
    "team_koschei": { "wins": 0, "losses": 0 },
    "team_svarog": { "wins": 0, "losses": 0 },
    "team_frost": { "wins": 0, "losses": 0 },
    "team_ancestors": { "wins": 0, "losses": 0 },
    "team_winds": { "wins": 0, "losses": 0 }
  }
}
```$
*Note: The `team_...` keys must match the unique `teamId` strings used in the game's configuration files.*

---

## 4. Core Logic & Method Implementation (Pseudocode)

This section details the internal logic of the manager.

**`function init()`:**
1.  `dataString = localStorage.getItem(STORAGE_KEY)`.
2.  **IF `dataString` is null or empty:**
    *   `this.stats = _createDefaultSchema()`.
    *   `saveStats()`.
    *   RETURN.
3.  **TRY:**
    *   `parsedData = JSON.parse(dataString)`.
4.  **CATCH (error):**
    *   `console.error("Failed to parse stats data. Resetting to default.", error)`.
    *   `this.stats = _createDefaultSchema()`.
    *   `saveStats()`.
    *   RETURN.
5.  **IF `parsedData.version` is not defined OR `parsedData.version < CURRENT_SCHEMA_VERSION`:**
    *   `this.stats = _migrate(parsedData)`. // Handle migration
    *   `saveStats()`.
6.  **ELSE:**
    *   `this.stats = parsedData`. // Data is valid and current

**`function updateStats(gameResult)`:**
*   `gameResult` object will be `{ winnerTeamId: 'team_svarog', loserTeamId: 'team_winds' }`.
1.  **IF `this.stats.stats[gameResult.winnerTeamId]` exists:**
    *   `this.stats.stats[gameResult.winnerTeamId].wins++`.
2.  **IF `this.stats.stats[gameResult.loserTeamId]` exists:**
    *   `this.stats.stats[gameResult.loserTeamId].losses++`.
3.  `saveStats()`. // Auto-save after every update

**`function saveStats()`:**
1.  `this.stats.lastModified = new Date().toISOString()`.
2.  `localStorage.setItem(STORAGE_KEY, JSON.stringify(this.stats))`.

**`function _createDefaultSchema()` (Private):**
*   Returns a new object matching the Version 1 Data Schema with all wins/losses set to 0. It should read the list of team IDs from the main game config to be future-proof.

**`function _migrate(oldData)` (Private):**
*   This function future-proofs the application.
*   **SWITCH (`oldData.version`):**
    *   `case undefined:` // Legacy data from a pre-versioning build
        *   // Attempt to map old fields to new schema if possible.
        *   // For v1, it's safest to reset.
        *   `RETURN _createDefaultSchema()`.
    *   // `case 1:` (When CURRENT_SCHEMA_VERSION becomes 2)
        *   // `// Logic to migrate from v1 to v2 would go here.`
        *   // `// e.g., add new teams with 0 wins/losses.`
*   `RETURN _createDefaultSchema()` // Default fallback if migration fails.

---

## 5. Integration with the Application

*   **App Start:** The main `GameController` must call `LocalStorageManager.init()` once the application is initialized.
*   **Game Over:** After a match, the `GameOver_Modal` will emit an event that triggers `LocalStorageManager.updateStats(result)`.
*   **Stats Screen:** The `Stats.vue` component will call `LocalStorageManager.getStats()` to retrieve the data for display.
*   **Options Menu:** A "Reset Stats" button in the options menu will call `LocalStorageManager.resetStats()` after a confirmation prompt.